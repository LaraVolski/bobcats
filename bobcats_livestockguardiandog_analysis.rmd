---
title: "bobcat_lgd_analysis"
author: "Lara Volski"
date: "3/4/2022"
output: html_document
---

---
title: "bobcat_lgd_analysis"
output: html_document
---
# Part 1) Setting up

### 1.1 Load Packages
```{r library.packages, include = FALSE}
library(nlme)
library(ggplot2)
library(overlap)
library(maptools)
library(lubridate)
library(plyr)
library(camtrapR)
library(dplyr)
library(lme4)
library(MASS)
library(circular) #Watson2Test
library(ggpattern)
library(tidyverse)
library(shiny)
library(shinythemes)
library(overlap)
library(here)
library(shinydashboard)
library(leaflet)
library(sp)
library(rgdal)
library(broom)
library(viridis)
library(ggmap)
library(magrittr)
library(sf)
library(scales)
library(tidyverse)
```

### 1.2 Read in CSVs
```{r csvs}
# first the record tables
record.table.phase1 <- read.csv("recordtable_phase1_15min.csv")
record.table.phase2 <- read.csv("recordtable_phase2_15min.csv")
record.table.phase3 <- read.csv("recordtable_phase3_15min.csv")
record.table.phase4 <- read.csv("recordtable_phase4_15min.csv")

#correct phase dates
record.table.phase1$Date <- format(as.Date(record.table.phase1$Date), "%m-%d-%Y")
record.table.phase2$Date <- format(as.Date(record.table.phase2$Date), "%m-%d-%Y")
record.table.phase3$Date <- format(as.Date(record.table.phase3$Date), "%m-%d-%Y")
record.table.phase4$Date <- format(as.Date(record.table.phase4$Date), "%m-%d-%Y")

# combine record tables
record.table.all <- bind_rows(record.table.phase1, record.table.phase2, record.table.phase3, record.table.phase4)

## Question -- are the record table time intervals already set so that all photos that occured within 15 min will count as one detection? # I believe so, after comparing it to other recordtables in Dropbox.

# import camera phase operation dates
cam.operation.all.phases <- read.csv("camera_operation_all_phases1234.csv", header=T)

# reading in metadata
metadata <- read.csv("camera_metadata_rasters.csv", header=T)
```

### Create a Camera Operation Matrix
```{r camera.operation.matrix}
# generate camera operation matrix
camera.operation.matrix <- cameraOperation(CTtable = cam.operation.all.phases,
                                           stationCol = "Camera",
                                           setupCol = "Start",
                                           retrievalCol = "End",
                                           dateFormat = "%m/%d/%Y",
                                           hasProblems = TRUE,
                                           writecsv = FALSE)

# Turn matrix into a dataframe
camera.operation.matrix <- rownames_to_column(as.data.frame(camera.operation.matrix), var = "Camera")

```

### Create a Classification Table
```{r define unique classifications}
# Define unique classification categories. We will need this later to ensure these columns are present in all tables. This list should be mutually exclusive with the species excluded above (probably a neater way to have done this, but can cross-check using 'unique' function).

# define list of all classification columns that we want 
allclassifications <- c(Bobcat = NA_real_, Coyote = NA_real_, Deer_Doe = NA_real_,
                        Deer_Other = NA_real_, Deer_Fawn = NA_real_, Deer_Buck_Legal = NA_real_,
                        Deer_Buck_Spike = NA_real_, Deer_Buck_Young_Button = NA_real_,
                        Deer_Buck_Antlerless = NA_real_, Squirrel = NA_real_, Fox = NA_real_, 
                        Skunk = NA_real_, Bear = NA_real_, Mountain_Lion = NA_real_, Raccoon = NA_real_,
                        Jack_Rabbit = NA_real_, Dog = NA_real_, Sheep = NA_real_, Pig = NA_real_,
                        Deer_Buck = NA_real_, Deer = NA_real_)  

# double check (here, there are 21 unique classifications)
length(allclassifications)
unique(record.table.all$Classification)
```

### Kaitlyn's RAI Code
```{r}
## RAI calculation

#### Define rai.calculate function
# Create function that takes an operation matrix and record table and calculates RAI for dates of interest.
#For this function to work, the record table must have a column called "Date" and it should have dates formatted as YYYY-MM-DD. The start and end date should be character strings formatted as "YYYY-MM-DD".

rai.calculate <- function(record.table, start.date, end.date, camop, timeperiod.name) {
  # define names to use in file names (just removes the dashes)
  start.name <- gsub("-", "", start.date)
  end.name <- gsub("-", "", end.date)
  
  # calculate how long the camera was functioning in that time period
    
    # selects columns within specified dates
    camop.subset <- dplyr::select(camop, Camera, start.date:end.date) 
    
    # sum rows within specified dates (there are 1s when camera was operating, NA when not)
    camop.subset$Operation <- rowSums(dplyr::select(camop.subset, start.date:end.date), na.rm=TRUE) 
    
    # get rid of the individual day columns, just select Camera, Operation
    camop.subset <- dplyr::select(camop.subset, Camera, Operation)
    
  # format start and end dates as dates
  start.date <- as.Date(start.date)
  end.date <- as.Date(end.date)
  
  # subset record table to date of interest
  record.table.subset <- record.table[record.table$Date >= start.date & record.table$Date <= end.date,]
  
  # calculate number of observations of each classification type at each camera
  records <- record.table.subset %>%
      dplyr::group_by(Classification, Camera) %>%
      dplyr::summarise(Detections = n()) %>%     # counts number of observations of each species
      spread(key = Classification, value = Detections)  # gets from long to wide format  
  
  # add columns for classes not present
  records <- add_column(records, !!!allclassifications[!names(allclassifications) %in% names(records)])
  
  # gather data so each class-camera is its own row again
  records <- records %>% gather(2:ncol(records), key = "Class", value = "Count")
  
  # replace NA with 0 
  records[is.na(records)] <- 0
  
  # join camera operation dates and observations
  RAI.table <- plyr::join(records, camop.subset)
  
  # calculate RAI
  RAI.table$RAI <- RAI.table$Count / RAI.table$Operation
  
  # add new column for time period
  RAI.table$TimePeriod <- timeperiod.name
  
  # write csv
  write.csv(RAI.table, file = paste("RAI_", timeperiod.name, "_", start.name, "_", end.name, ".csv", collapse = "", sep = ""),row.names=F)
    
  return(RAI.table)
  
}
```  

#### The RAI function in action
Here is an example of the RAI function in action
```{r calculate RAI, message = F}

## only doing 3 months for now, but the idea is that it'll be march.2016, march.2017, march.2018, and so forth...

## how do I account for the fact that march/2016 is shorter than other months bc dataset doesn't start until march 22?
march.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-03-22", end.date = "2016-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2016")

april.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-04-01", end.date = "2016-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2016")

may.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-05-01", end.date = "2016-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2016")


```

#### Combine RAI across seasons

# Combine these before, during, and after hunt periods back together into a single data frame and add a column corresponding to the hunt period. 

```{r RAI combine}
# combine different RAI files
all.rai <- rbind(march.2016, april.2016, may.2016)

# add column for time period relative to month
all.rai$month <- NA
for (i in 1:nrow(all.rai)) {
  if (all.rai$TimePeriod[i] == "march.2016" | all.rai$TimePeriod[i] == "april.2016") {
    all.rai$month[i] <- "March2016"
  }
  if (all.rai$TimePeriod[i] == "april.2016" | all.rai$TimePeriod[i] == "may.2016") {
    all.rai$month[i] <- "April2016"
  }
  if (all.rai$TimePeriod[i] == "may.2016" | all.rai$TimePeriod[i] == "june.2016" ) {
    all.rai$month[i] <- "May2016"
  }
}

# specify the factor level (so they plot in this order)
all.rai$month <- fct_relevel(all.rai$month, "march.2016", "april.2016", "may.2016")
# convert RAI to log scale, but first add 1 to everything so that 0s can be transformed
all.rai$RAI.log <- log(all.rai$RAI + 1)
# also apply square root transformation, to see if that changes anything
all.rai$RAI.sqrt <- sqrt(all.rai$RAI)
```


For cameras that were operating for fewer than 10 days, I change the RAI to NA, because I don't want to calculate RAI based on so few trap-nights.

```{r RAI clean}
# for cameras that were operating <10 days, change Count and RAI to NA
for (i in 1:nrow(all.rai)) {
  if(all.rai$Operation[i] < 10) {
    all.rai$Count[i] <- NA
    all.rai$RAI[i] <- NA
    all.rai$RAI.log[i] <- NA
  } 
}
```
```

For cameras that were operating for fewer than 10 days, I change the RAI to NA, because I don't want to calculate RAI based on so few trap-nights.

```{r RAI clean}
# for cameras that were operating <10 days, change Count and RAI to NA
for (i in 1:nrow(all.rai)) {
  if(all.rai$Operation[i] < 10) {
    all.rai$Count[i] <- NA
    all.rai$RAI[i] <- NA
    all.rai$RAI.log[i] <- NA
  } 
}
```


Calculate mean, SD, and standard error of RAI for each species/class (across cameras), with one row per species/class. Not actually using this for anything yet... code's here if need be. This particular approach isn't very good since it counts each camera 6 times (once per year-season).
```{r summarize class RAI}
# note that for species-camera pairs where there were no detections, the row is missing (rather than NA)
rai.class.summary <- all.rai %>%
  dplyr::group_by(Class, TimePeriod) %>%
  dplyr::summarise(RAI.mean = mean(RAI, na.rm=T), 
                   RAI.sd = sd(RAI, na.rm=T), 
                   RAI.se = std.error(RAI, na.rm=T))
```


### Convert RAI table from long to wide

Reshape the RAI table to combine records and operation dates from 2016 and 2017 seasons, and recalculate overall RAI for the periods before, during, and after the hunt. Then spread so that there are columns for each class RAI before, during, and after hunt, with one row for each camera.
```{r long to wide}
# summarize count and operation dates for before/during/after (combine 2016 and 2017 records)
rai.summarized <- all.rai %>%
  dplyr::group_by(Camera, Class, Hunt) %>%
  dplyr::summarise(Operation = sum(Operation, na.rm=T), 
                   Count = sum(Count, na.rm=T))
# recalculate RAI for each species-period
rai.summarized$RAI <- rai.summarized$Count / rai.summarized$Operation
# recalculate log RAI for each species-period
rai.summarized$RAI.log <- log(rai.summarized$RAI + 1)
# and recalculate square root of RAI for each species-period
rai.summarized$RAI.sqrt <- sqrt(rai.summarized$RAI + 1)
# combine species and season into new column to use as key
rai.summarized$Class_Hunt <- paste(rai.summarized$Class, "_", rai.summarized$Hunt, sep = "")
# take just columns with camera, RAI, and key
rai.wide <- rai.summarized[,c(1,6,9)]
# spread so each class and season RAI (before, during, after hunt) is in its own column
rai.wide <- tidyr::spread(rai.wide, key = Class_Hunt, value = RAI)
# take just columns with camera, RAI.log, and key
rai.wide.log <- rai.summarized[,c(1,7,9)]
# spread so each class and season log RAI (before, during, after hunt) is in its own column
rai.wide.log <- tidyr::spread(rai.wide.log, key = Class_Hunt, value = RAI.log)
# take just columns with camera, RAI.sqrt, and key
rai.wide.sqrt <- rai.summarized[,c(1,8,9)]
# spread so each class and season sqrt RAI (before, during, after hunt) is in its own column
rai.wide.sqrt <- tidyr::spread(rai.wide.sqrt, key = Class_Hunt, value = RAI.sqrt)
```

Merge camera metadata with RAI.

```{r merge metadata with RAI, message = F}
covariates <- read.csv(file = here::here('data', 'camera_metadata_rasters.csv'))
# merge all of these with covariates
rai.summarized <- merge(rai.summarized, covariates)
rai.wide <- merge(rai.wide, covariates)
rai.wide.log <- merge(rai.wide.log, covariates)
all.rai <- plyr::join(all.rai, covariates)
```




```{r}
# code to add later:

## by month code
# june.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-06-01", end.date = "2016-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2016")

# july.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-07-01", end.date = "2016-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2016")

# august.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-08-01", end.date = "2016-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2016")

# september.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-09-01", end.date = "2016-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2016")

# october.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-10-01", end.date = "2016-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2016")

# november.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-11-01", end.date = "2016-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2016")

# december.2016 <- rai.calculate(record.table = record.table.all, start.date = "2016-12-01", end.date = "2016-12-31", camop = camera.operation.matrix, timeperiod.name = "december.2016")

# january.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-01-01", end.date = "2017-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2017")

# february.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-02-01", end.date = "2017-02-28", camop = camera.operation.matrix, timeperiod.name = "february.2017")

# march.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-03-01", end.date = "2017-03-31", camop = camera.operation.matrix, timeperiod.name = "march.2017")

# april.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-04-01", end.date = "2017-04-30", camop = camera.operation.matrix, timeperiod.name = "april.2017")

# may.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-05-01", end.date = "2017-05-31", camop = camera.operation.matrix, timeperiod.name = "may.2017")

# june.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-06-01", end.date = "2017-06-30", camop = camera.operation.matrix, timeperiod.name = "june.2017")

# july.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-07-01", end.date = "2017-07-31", camop = camera.operation.matrix, timeperiod.name = "july.2017")

# august.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-08-01", end.date = "2017-08-31", camop = camera.operation.matrix, timeperiod.name = "august.2017")

# september.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-09-01", end.date = "2017-09-30", camop = camera.operation.matrix, timeperiod.name = "september.2017")

# october.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-10-01", end.date = "2017-10-31", camop = camera.operation.matrix, timeperiod.name = "october.2017")

# november.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-11-01", end.date = "2017-11-30", camop = camera.operation.matrix, timeperiod.name = "november.2017")

# december.2017 <- rai.calculate(record.table = record.table.all, start.date = "2017-12-01", end.date = "2017-12-31", camop = camera.operation.matrix, timeperiod.name = "december.2017")

# january.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-01-01", end.date = "2018-01-31", camop = camera.operation.matrix, timeperiod.name = "january.2018")

# february.2018 <- rai.calculate(record.table = record.table.all, start.date = "2018-02-01", end.date = "2016-12-28", camop = camera.operation.matrix, timeperiod.name = "february.2018")

## all rai code
all.rai <- rbind(march.2016, april.2016, may.2016, june.2016, july.2016, august.2016, september.2016, october.2016, november.2016, december.2016, january.2017, february.2017, march.2017, april.2017, may.2017, june.2017, july.2017, august.2017, september.2017, october.2017, november.2017, december.2017)


## loop code
  if (all.rai$TimePeriod[i] == "june.2016" | all.rai$TimePeriod[i] == "july.2016" ) {
    all.rai$montht[i] <- "June2016"
  }
  if (all.rai$TimePeriod[i] == "july.2016" | all.rai$TimePeriod[i] == "august.2016" ) {
    all.rai$montht[i] <- "July2016"
  }
  if (all.rai$TimePeriod[i] == "august.2016" | all.rai$TimePeriod[i] == "september.2016" ) {
    all.rai$montht[i] <- "August2016"
  }
  if (all.rai$TimePeriod[i] == "september.2016" | all.rai$TimePeriod[i] == "october.2016" ) {
    all.rai$montht[i] <- "September2016"
  }
  if (all.rai$TimePeriod[i] == "october.2016" | all.rai$TimePeriod[i] == "november.2016" ) {
    all.rai$montht[i] <- "October2016"
  }
  if (all.rai$TimePeriod[i] == "november.2016" | all.rai$TimePeriod[i] == "december.2016" ) {
    all.rai$montht[i] <- "November2016"
  }
  if (all.rai$TimePeriod[i] == "december.2016" | all.rai$TimePeriod[i] == "january.2017" ) {
    all.rai$montht[i] <- "December2016"
  }
  if (all.rai$TimePeriod[i] == "january.2017" | all.rai$TimePeriod[i] == "february.2017" ) {
    all.rai$montht[i] <- "January2017"
  }
  if (all.rai$TimePeriod[i] == "february.2017" | all.rai$TimePeriod[i] == "march.2017" ) {
    all.rai$montht[i] <- "February2017"
  }
  if (all.rai$TimePeriod[i] == "march.2017" | all.rai$TimePeriod[i] == "april.2017" ) {
    all.rai$montht[i] <- "March2017"
  }
  if (all.rai$TimePeriod[i] == "april.2017" | all.rai$TimePeriod[i] == "may.2017" ) {
    all.rai$montht[i] <- "April2017"
  }
  if (all.rai$TimePeriod[i] == "may.2017" | all.rai$TimePeriod[i] == "june.2017" ) {
    all.rai$montht[i] <- "May2017"
  }
  if (all.rai$TimePeriod[i] == "june.2017" | all.rai$TimePeriod[i] == "july.2017" ) {
    all.rai$montht[i] <- "June2017"
  }
  if (all.rai$TimePeriod[i] == "july.2017" | all.rai$TimePeriod[i] == "august.2017" ) {
    all.rai$montht[i] <- "July2017"
  }
  if (all.rai$TimePeriod[i] == "august.2017" | all.rai$TimePeriod[i] == "september.2017" ) {
    all.rai$montht[i] <- "August2017"
  }
```















### Kaitlyn's Shiny Code -- ignore for now
```{r}

# Data import -------------------------------------------------------------

# Just for Phase 1 here
record.table.phase1$Date <- as.Date(record.table.phase1$Date)
## strip just month
record.table.phase1$Month_Year <- format(as.Date(record.table.phase1$Date), "%Y-%m")

# import camera operation spreadsheet
# this code is turning the date into 2020!!! not 2016/2017!
cam.operation.phase1 <- read_csv("camera_operation_phase1.csv") %>%
  mutate_at(c("Start", "End", "Problem1_from", "Problem1_to"),
            ~as.Date(., format = "%m/%d/%y"))

# import camera metadata
metadata <- read.csv("camera_metadata_rasters.csv", header=T) %>% 
  rename(Elevation = elevation.clean, Slope = slope.clean, Vegetation = vegetation.clean,
         Vegetation_Coarser = vegetation.coarser.clean2, BLM_Dist = blm.dist.clean,
         Boundary_Dist = bound.dist.clean, Fence_Dist = fence.dist.clean, HQ_Dist = hq.dist.clean,
         Road_Dist = road.dist.clean, Water_Dist = water.dist.clean, Ruggedness9 = rugged9.clean,
         Ruggedness25 = rugged25.clean, Ruggedness49 = rugged49.clean, Ruggedness81 = rugged81.clean,
         Ruggedness121 = rugged121.clean, Viewshed = viewshed.clean, Viewshed_Reclass = viewshed.reclass.clean,
         NDVI2016 = ndvi.16.clean.1, Vegetation_Edge_Dist = veg.edges.dist.clean, Chaparral_Edge_Dist = chap.edges.dist.clean)

# specify seasons for each month-year
seasons <- tibble(
  Month_Year = c("2016-03", "2016-04", "2016-05", "2016-06", 
                 "2016-07", "2016-08", "2016-09", "2016-10", "2016-11", "2016-12",
                 "2017-01", "2017-02", "2017-03", "2017-04", "2017-05", "2017-06", 
                 "2017-07", "2017-08", "2017-09", "2017-10", "2017-11", "2017-12",
                 "2018-01", "2018-02", "2018-03", "2018-04", "2018-05", "2018-06", 
                 "2018-07", "2018-08", "2018-09", "2018-10", "2018-11", "2018-12",
                 "2019-01", "2019-02", "2019-03", "2019-04", "2019-05", "2019-06", 
                 "2019-07", "2019-08", "2019-09", "2019-10", "2019-11", "2019-12"),
  Season = c("Spring", "Spring", "Spring", "Summer", 
             "Summer", "Summer", "Fall", "Fall", "Fall", "Winter",
             "Winter", "Winter", "Spring", "Spring", "Spring", "Summer", 
             "Summer", "Summer", "Fall", "Fall", "Fall", "Winter",
             "Winter", "Winter", "Spring", "Spring", "Spring", "Summer", 
             "Summer", "Summer", "Fall", "Fall", "Fall", "Winter",
             "Winter", "Winter", "Spring", "Spring", "Spring", "Summer", 
             "Summer", "Summer", "Fall", "Fall", "Fall", "Winter")
)

# Data manipulation -------------------------------------------------------

# join records and camera operation
record.table.phase1 <- left_join(record.table.phase1, cam.operation.phase1)

rai.monthly <- function(record.table.subset, camop, start.date, end.date) {
  
  # calculate how long the camera was functioning in that time period
  
  # change start and end date to character
  start.date <- as.character(start.date)
  end.date <- as.character(end.date)
  
  # selects columns within specified dates
  camop.subset <- dplyr::select(camop, Camera, start.date:end.date)
  
  # transpose data frame
  camop.subset.monthly <- as_tibble(cbind(names(camop.subset), t(camop.subset)))
  colnames(camop.subset.monthly) <- as.character(unlist(camop.subset.monthly[1,]))
  camop.subset.monthly = camop.subset.monthly[-1, ]
  
  # fix to make numeric
  camop.subset.monthly[, 2:ncol(camop.subset.monthly)] %<>% mutate_if(is.character, as.numeric)
  
  # sum operation for all cameras
  camop.subset.monthly$All <- camop.subset.monthly %>%
    select(-Camera) %>%
    rowSums(na.rm = TRUE)
  
  # add column for just month
  camop.subset.monthly$Month_Year <- format(as.Date(camop.subset.monthly$Camera), "%Y-%m")
  
  # calculate number of operation days for each camera in each month-year
  camop.subset.monthly.summary <- camop.subset.monthly %>%
    dplyr::select(All, Month_Year) %>% # just select "all' and "Month_Year"
    dplyr::group_by(Month_Year) %>%
    dplyr::summarise(Operation = sum(All, na.rm = TRUE))
  
  # calculate for all cameras combined for each month-year
  record_count_all <- record.table.subset %>%
    dplyr::group_by(Month_Year) %>%
    dplyr::summarise(Detections = n()) 
  
  # join camera operation dates and observations
  RAI.table <- full_join(record_count_all, camop.subset.monthly.summary)
  
  # replace NA with 0 
  RAI.table[is.na(RAI.table)] <- 0
  
  # calculate RAI
  RAI.table$RAI <- RAI.table$Detections / RAI.table$Operation
  
  # replace infinity with NA
  RAI.table %<>% mutate_if(is.numeric, list(~na_if(., Inf)))
  
  # merge with season
  RAI.table <- left_join(RAI.table, seasons) %>% as.data.frame()
  
  return(RAI.table)
  
}

rai.monthly(record.table.subset = record.table.phase1, camop = record.table.phase1, 2016-03-22, 2017-12-22)

```